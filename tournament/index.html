<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swiss Tournament</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // Lucide icons as inline SVG components
    const Trophy = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
        <path d="M4 22h16"></path>
        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
      </svg>
    );

    const Users = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
    );

    function SwissTournament() {
      const [phase, setPhase] = useState('setup');
      const [playerNames, setPlayerNames] = useState('John\nAnnette\nLaurel\nBen\nLynette\nDarren\nEthan\nFawn\nAudra\nReagan\nKiera\nChris\nHeather\nAnna\nNathan\nClaire');
      const [players, setPlayers] = useState([]);
      const [currentRound, setCurrentRound] = useState(1);
      const [matches, setMatches] = useState([]);
      const [totalRounds, setTotalRounds] = useState(0);

      const startTournament = () => {
        const names = playerNames
          .split('\n')
          .map(n => n.trim())
          .filter(n => n.length > 0);
        
        if (names.length < 2) {
          alert('Please enter at least 2 players');
          return;
        }

        // Randomize the order
        const shuffledNames = names.sort(() => Math.random() - 0.5);

        const playerObjs = shuffledNames.map((name, i) => ({ 
          id: i, 
          name, 
          points: 0, 
          opponents: [],
          buchholz: 0 
        }));
        
        setPlayers(playerObjs);
        
        // Calculate number of rounds (typically ceil(log2(n)))
        const rounds = Math.ceil(Math.log2(names.length));
        setTotalRounds(rounds);
        
        // Generate first round pairings (random for round 1)
        generateRoundPairings(playerObjs, 1);
        setPhase('tournament');
      };

      const generateRoundPairings = (currentPlayers, round) => {
        let availablePlayers = [...currentPlayers];
        const newMatches = [];

        if (round === 1) {
          // First round: random pairing
          availablePlayers.sort(() => Math.random() - 0.5);
        } else {
          // Subsequent rounds: pair by points (Swiss system)
          availablePlayers.sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            return b.buchholz - a.buchholz; // Tiebreaker
          });
        }

        // Create pairings
        while (availablePlayers.length >= 2) {
          const player1 = availablePlayers.shift();
          
          // Find opponent who hasn't played this player yet
          let opponentIdx = 0;
          while (opponentIdx < availablePlayers.length && 
                 player1.opponents.includes(availablePlayers[opponentIdx].id)) {
            opponentIdx++;
          }
          
          if (opponentIdx < availablePlayers.length) {
            const player2 = availablePlayers.splice(opponentIdx, 1)[0];
            newMatches.push({
              id: `r${round}-${player1.id}-${player2.id}`,
              player1,
              player2,
              winner: null
            });
          } else {
            // No valid opponent found, give bye
            newMatches.push({
              id: `r${round}-${player1.id}-bye`,
              player1,
              player2: null,
              winner: null,
              isBye: true
            });
          }
        }

        // Handle odd player with bye
        if (availablePlayers.length === 1) {
          newMatches.push({
            id: `r${round}-${availablePlayers[0].id}-bye`,
            player1: availablePlayers[0],
            player2: null,
            winner: null,
            isBye: true
          });
        }

        setMatches(newMatches);
      };

      const recordResult = (matchId, winnerId) => {
        const updatedMatches = matches.map(m => 
          m.id === matchId ? { ...m, winner: winnerId } : m
        );
        setMatches(updatedMatches);
      };

      const endRound = () => {
        // Update player points based on final match results
        const updatedPlayers = players.map(p => {
          const playerMatches = matches.filter(m => 
            m.player1.id === p.id || m.player2?.id === p.id
          );
          
          const wins = playerMatches.filter(m => m.winner === p.id).length;
          const newOpponents = playerMatches
            .filter(m => !m.isBye)
            .map(m => m.player1.id === p.id ? m.player2.id : m.player1.id)
            .filter(oppId => !p.opponents.includes(oppId));
          
          return {
            ...p,
            points: p.points + wins,
            opponents: [...p.opponents, ...newOpponents]
          };
        });

        // Calculate Buchholz scores
        const withBuchholz = updatedPlayers.map(p => ({
          ...p,
          buchholz: p.opponents.reduce((sum, oppId) => {
            const opp = updatedPlayers.find(pl => pl.id === oppId);
            return sum + (opp ? opp.points : 0);
          }, 0)
        }));
        
        setPlayers(withBuchholz);

        if (currentRound < totalRounds) {
          // Continue to next regular round
          setCurrentRound(currentRound + 1);
          generateRoundPairings(withBuchholz, currentRound + 1);
        } else {
          // Check if we need tiebreaker rounds
          const sorted = [...withBuchholz].sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            return b.buchholz - a.buchholz;
          });

          // Check for ties at the top
          const topScore = sorted[0].points;
          const topBuchholz = sorted[0].buchholz;
          const tiedPlayers = sorted.filter(p => p.points === topScore && p.buchholz === topBuchholz);

          if (tiedPlayers.length > 1) {
            // We have a tie, need tiebreaker round
            setCurrentRound(currentRound + 1);
            setTotalRounds(totalRounds + 1);
            
            // Create tiebreaker matches between tied players
            const tiebreakerMatches = [];
            const availableTied = [...tiedPlayers];
            
            while (availableTied.length >= 2) {
              const p1 = availableTied.shift();
              const p2 = availableTied.shift();
              tiebreakerMatches.push({
                id: `tiebreaker-${currentRound + 1}-${p1.id}-${p2.id}`,
                player1: p1,
                player2: p2,
                winner: null
              });
            }
            
            setMatches(tiebreakerMatches);
          } else {
            // No ties, tournament complete
            setPhase('complete');
          }
        }
      };

      const reset = () => {
        setPhase('setup');
        setPlayerNames('');
        setPlayers([]);
        setCurrentRound(1);
        setMatches([]);
        setTotalRounds(0);
      };

      const getSortedStandings = () => {
        return [...players].sort((a, b) => {
          if (b.points !== a.points) return b.points - a.points;
          return b.buchholz - a.buchholz;
        });
      };

      if (phase === 'setup') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-lg shadow-xl p-8">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-8 h-8 text-indigo-600"><Trophy /></div>
                  <h1 className="text-3xl font-bold text-gray-900">Swiss Tournament</h1>
                </div>
                
                <p className="text-gray-600 mb-6">
                  Enter player names (one per line). The tournament will use Swiss-system pairing to efficiently rank all players.
                </p>

                <textarea
                  className="w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none font-mono"
                  placeholder="Player 1&#10;Player 2&#10;Player 3&#10;..."
                  value={playerNames}
                  onChange={(e) => setPlayerNames(e.target.value)}
                />
                <button
                  onClick={startTournament}
                  className="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                >
                  <div className="w-5 h-5"><Users /></div>
                  Start Tournament
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (phase === 'tournament') {
        const sortedStandings = getSortedStandings();
        const completedMatches = matches.filter(m => m.winner !== null).length;
        const totalMatches = matches.length;
        const allMatchesComplete = completedMatches === totalMatches;

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div className="max-w-7xl mx-auto h-screen flex flex-col py-4">
              <div className="bg-white rounded-lg shadow-lg p-3 mb-4">
                <div className="flex items-center justify-between gap-4">
                  <h2 className="text-lg font-bold text-gray-900 whitespace-nowrap">Swiss Tournament</h2>
                  <div className="flex-1 flex items-center gap-3">
                    <div className="flex-1">
                      <div className="flex items-center justify-between mb-1">
                        <span className="text-xs text-gray-600">
                          Round {currentRound} of {totalRounds}
                          {currentRound > Math.ceil(Math.log2(players.length)) && ' (Tiebreaker)'}
                        </span>
                        <span className="text-sm font-bold text-indigo-600">
                          {completedMatches} / {totalMatches} matches
                        </span>
                      </div>
                      <div className="bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div
                          className="bg-indigo-600 h-full transition-all duration-300"
                          style={{ width: `${(completedMatches / totalMatches) * 100}%` }}
                        />
                      </div>
                    </div>
                    {allMatchesComplete && (
                      <button
                        onClick={endRound}
                        className="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors whitespace-nowrap"
                      >
                        End Round
                      </button>
                    )}
                  </div>
                </div>
              </div>

              <div className="flex-1 grid grid-cols-2 gap-4 min-h-0">
                <div className="bg-white rounded-lg shadow-xl p-6 flex flex-col min-h-0">
                  <h2 className="text-xl font-bold text-gray-900 mb-4">Matches</h2>
                  
                  <div className="flex-1 overflow-y-auto min-h-0">
                    <div className="space-y-3">
                      {matches.map((match) => (
                        <div
                          key={match.id}
                          className="p-3 rounded-lg border-2 bg-white border-indigo-200"
                        >
                          {match.isBye ? (
                            <div className="text-center">
                              <div className="font-semibold text-gray-900 mb-2">{match.player1.name}</div>
                              <button
                                onClick={() => recordResult(match.id, match.winner === match.player1.id ? null : match.player1.id)}
                                className={`w-full py-2 px-4 rounded transition-colors ${
                                  match.winner === match.player1.id
                                    ? 'bg-green-500 hover:bg-green-600 text-white'
                                    : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                                }`}
                              >
                                {match.winner === match.player1.id ? '✓ Bye (Win)' : 'Bye (Click for Win)'}
                              </button>
                            </div>
                          ) : (
                            <div className="flex gap-2 items-center">
                              <button
                                onClick={() => recordResult(match.id, match.winner === match.player1.id ? null : match.player1.id)}
                                className={`flex-1 py-3 px-3 rounded font-semibold transition-colors ${
                                  match.winner === match.player1.id
                                    ? 'bg-green-500 hover:bg-green-600 text-white'
                                    : match.winner === match.player2.id
                                    ? 'bg-gray-200 hover:bg-gray-300 text-gray-500'
                                    : 'bg-blue-500 hover:bg-blue-600 text-white'
                                }`}
                              >
                                {match.winner === match.player1.id && '✓ '}
                                {match.player1.name}
                              </button>
                              <span className="text-gray-400 font-bold">vs</span>
                              <button
                                onClick={() => recordResult(match.id, match.winner === match.player2.id ? null : match.player2.id)}
                                className={`flex-1 py-3 px-3 rounded font-semibold transition-colors ${
                                  match.winner === match.player2.id
                                    ? 'bg-green-500 hover:bg-green-600 text-white'
                                    : match.winner === match.player1.id
                                    ? 'bg-gray-200 hover:bg-gray-300 text-gray-500'
                                    : 'bg-blue-500 hover:bg-blue-600 text-white'
                                }`}
                              >
                                {match.winner === match.player2.id && '✓ '}
                                {match.player2.name}
                              </button>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-xl p-6 flex flex-col min-h-0">
                  <h2 className="text-xl font-bold text-gray-900 mb-4">Current Standings</h2>
                  
                  <div className="flex-1 overflow-y-auto min-h-0">
                    <div className="space-y-1">
                      {sortedStandings.map((player, idx) => (
                        <div
                          key={player.id}
                          className="flex items-center gap-3 p-2 bg-gradient-to-r from-indigo-50 to-transparent rounded-lg transition-all duration-300"
                        >
                          <div className="w-7 h-7 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">
                            {idx + 1}
                          </div>
                          <div className="flex-1 font-semibold text-gray-900 truncate">{player.name}</div>
                          <div className="text-sm font-bold text-indigo-600 flex-shrink-0">
                            {player.points} pts
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (phase === 'complete') {
        const finalStandings = getSortedStandings();

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-lg shadow-xl p-8">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 text-yellow-500 mx-auto mb-4"><Trophy /></div>
                  <h1 className="text-4xl font-bold text-gray-900 mb-2">Tournament Complete!</h1>
                  <p className="text-gray-600">Final Rankings ({totalRounds} rounds)</p>
                </div>

                <div className="space-y-3 mb-8">
                  {finalStandings.map((player, idx) => (
                    <div
                      key={player.id}
                      className={`flex items-center gap-4 p-4 rounded-lg ${
                        idx === 0 ? 'bg-gradient-to-r from-yellow-100 to-yellow-50 border-2 border-yellow-400' :
                        idx === 1 ? 'bg-gradient-to-r from-gray-100 to-gray-50 border-2 border-gray-400' :
                        idx === 2 ? 'bg-gradient-to-r from-orange-100 to-orange-50 border-2 border-orange-400' :
                        'bg-gradient-to-r from-indigo-50 to-transparent'
                      }`}
                    >
                      <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${
                        idx === 0 ? 'bg-yellow-500 text-white' :
                        idx === 1 ? 'bg-gray-400 text-white' :
                        idx === 2 ? 'bg-orange-500 text-white' :
                        'bg-indigo-600 text-white'
                      }`}>
                        {idx + 1}
                      </div>
                      <div className="flex-1">
                        <div className="text-xl font-semibold text-gray-900">{player.name}</div>
                        <div className="text-sm text-gray-600">
                          {player.points} points • Buchholz: {player.buchholz}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <button
                  onClick={reset}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                >
                  New Tournament
                </button>
              </div>
            </div>
          </div>
        );
      }
    }

    ReactDOM.render(<SwissTournament />, document.getElementById('root'));
  </script>
</body>
</html>
